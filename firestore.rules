rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.memberGrade == 'admin';
    }

    // users: 본인 데이터만 읽기
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false; // Functions만 쓰기 가능
    }

    // payments: Functions만 접근
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.uid == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }

    // fortune_results: 본인 데이터만 읽기
    match /fortune_results/{resultId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.uid == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }

    // subscriptions: 본인 구독만 읽기
    match /subscriptions/{subId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.uid == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }

    // referral_credits: 본인 크레딧만 읽기
    match /referral_credits/{creditId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.referrerId == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }

    // withdrawal_requests: 본인 요청만 읽기
    match /withdrawal_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.uid == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }

    // system_config: 인증된 사용자 읽기, admin만 쓰기
    match /system_config/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 기본적으로 모든 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}